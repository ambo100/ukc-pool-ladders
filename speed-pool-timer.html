<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Speed Pool Timer</title>
<style>
  :root{ --bg:#111; --fg:#f8f8f8; --accent:#22c55e; --danger:#ef4444; --border:#333; }
  body{margin:0;font:16px/1.4 system-ui;background:var(--bg);color:var(--fg);}
  .tabs{display:flex;border-bottom:1px solid var(--border);}
  .tab{flex:1;text-align:center;padding:14px;font-weight:600;cursor:pointer;}
  .tab.active{background:#222;}
  .view{display:none;padding:20px;}
  .view.active{display:block;}
  .time{font-variant-numeric:tabular-nums;font-size:64px;text-align:center;margin:20px 0;}
  .status{text-align:center;margin-bottom:20px;color:#aaa;}
  .btn{display:block;width:100%;padding:24px;font-size:28px;font-weight:700;
       border:none;border-radius:14px;color:white;margin:10px 0;cursor:pointer;}
  .btn.start{background:var(--accent);}
  .btn.end{background:var(--danger);}
  .btn.reset{background:#3b82f6;}
  ul{list-style:none;padding:0;}
  li{display:flex;justify-content:space-between;align-items:center;
     padding:10px;border-bottom:1px solid var(--border);}
  li button{background:var(--danger);color:white;border:none;padding:6px 12px;
            border-radius:8px;cursor:pointer;}
  h2{margin-top:0;}
</style>
</head>
<body>
<div class="tabs">
  <div id="tabTimer" class="tab active">Timer</div>
  <div id="tabTimes" class="tab">Times</div>
</div>

<div id="timerView" class="view active">
  <div class="time" id="time">00:00.00</div>
  <div class="status" id="status">Tap Start and break to begin timing.</div>
  <button id="startBtn" class="btn start">START</button>
  <button id="endBtn" class="btn end" style="display:none">END</button>
  <button id="resetBtn" class="btn reset" style="display:none">RESET</button>
</div>

<div id="timesView" class="view">
  <h2>All Times</h2>
  <ul id="timesList"></ul>
  <h2>Top 5</h2>
  <ul id="topList"></ul>
</div>

<script>
(() => {
  let audioCtx, analyser, micStream, rafId;
  let timerRunning=false, armed=false, startPerf=0, timerRAF;
  let times=[];

  const timeEl=document.getElementById('time');
  const statusEl=document.getElementById('status');
  const startBtn=document.getElementById('startBtn');
  const endBtn=document.getElementById('endBtn');
  const resetBtn=document.getElementById('resetBtn');
  const timesList=document.getElementById('timesList');
  const topList=document.getElementById('topList');

  const fmt=(ms)=>{
    const m=Math.floor(ms/60000),s=Math.floor(ms%60000/1000),cs=Math.floor(ms%1000/10);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(cs).padStart(2,'0')}`;
  };

  async function setupMic(){
    if(audioCtx) return;
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new AudioContext();
    const src=audioCtx.createMediaStreamSource(micStream);
    analyser=audioCtx.createAnalyser(); analyser.fftSize=2048;
    src.connect(analyser);
  }

  function listen(){
    const buf=new Float32Array(analyser.fftSize);
    const loop=()=>{
      if(!timerRunning && armed){
        analyser.getFloatTimeDomainData(buf);
        let sum=0; for(let i=0;i<buf.length;i++){sum+=buf[i]*buf[i];}
        const rms=Math.sqrt(sum/buf.length);
        if(rms>0.2){ // spike threshold
          startTimer();
          armed=false;
        }
      }
      rafId=requestAnimationFrame(loop);
    };
    rafId=requestAnimationFrame(loop);
  }

  function startTimer(){
    if(timerRunning) return;
    timerRunning=true;
    startPerf=performance.now();
    startBtn.style.display='none'; resetBtn.style.display='none'; endBtn.style.display='block';
    statusEl.textContent='Timer running...';
    const tick=()=>{
      if(!timerRunning) return;
      timeEl.textContent=fmt(performance.now()-startPerf);
      timerRAF=requestAnimationFrame(tick);
    };
    timerRAF=requestAnimationFrame(tick);
  }

  function endTimer(){
    if(!timerRunning) return;
    timerRunning=false; cancelAnimationFrame(timerRAF);
    const final=performance.now()-startPerf;
    timeEl.textContent=fmt(final);
    times.push(final); renderTimes();
    statusEl.textContent='Timer ended. Reset to go again.';
    endBtn.style.display='none'; resetBtn.style.display='block';
  }

  function resetTimer(){
    timeEl.textContent='00:00.00';
    statusEl.textContent='Tap Start and break to begin timing.';
    startBtn.style.display='block'; endBtn.style.display='none'; resetBtn.style.display='none';
  }

  function renderTimes(){
    timesList.innerHTML='';
    times.forEach((t,i)=>{
      const li=document.createElement('li');
      li.textContent=fmt(t);
      const del=document.createElement('button'); del.textContent='Erase';
      del.onclick=()=>{times.splice(i,1);renderTimes();};
      li.appendChild(del);
      timesList.appendChild(li);
    });
    const sorted=[...times].sort((a,b)=>a-b).slice(0,5);
    topList.innerHTML='';
    sorted.forEach(t=>{
      const li=document.createElement('li');
      li.textContent=fmt(t);
      topList.appendChild(li);
    });
  }

  startBtn.onclick=async()=>{
    await setupMic();
    armed=true; listen();
    statusEl.textContent='Listening for break...';
  };
  endBtn.onclick=endTimer;
  resetBtn.onclick=resetTimer;

  // Tabs
  const tabTimer=document.getElementById('tabTimer');
  const tabTimes=document.getElementById('tabTimes');
  const timerView=document.getElementById('timerView');
  const timesView=document.getElementById('timesView');
  function showTab(tab){
    if(tab==='timer'){tabTimer.classList.add('active');tabTimes.classList.remove('active');
      timerView.classList.add('active');timesView.classList.remove('active');}
    else{tabTimes.classList.add('active');tabTimer.classList.remove('active');
      timesView.classList.add('active');timerView.classList.remove('active');}
  }
  tabTimer.onclick=()=>showTab('timer');
  tabTimes.onclick=()=>showTab('times');
})();
</script>
</body>
</html>
